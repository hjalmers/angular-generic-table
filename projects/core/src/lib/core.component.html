<table
  [ngClass]="(tableConfig$ | async)?.class || 'table'"
  [class.table-mobile]="(tableConfig$ | async)?.mobileLayout"
  [class.table-horizontal]="(tableConfig$ | async)?.rows"
  [class.table-loading]="loading$ | async"
  [class.gt-sticky-row-header]="
    (tableConfig$ | async)?.stickyHeaders?.row && (tableConfig$ | async)?.rows
  "
  [class.gt-sticky-column-header]="
    (tableConfig$ | async)?.stickyHeaders?.column
  "
  [attr.aria-busy]="(loading$ | async) === true ? true : null"
>
  <thead>
    <tr
      *ngIf="{
        config: (tableConfig$ | async)!,
        isLoading: loading$ | async
      } as table"
    >
      <ng-container
        *ngFor="let column of table.config?.columns | keyvalue: columnOrder"
      >
        <th
          *ngIf="!column.value?.hidden"
          ngClass="{{ (column.key | dashCase) + '-column' }} {{
            column.value.class
          }}"
          [class.disabled]="table.isLoading"
          [attr.aria-sort]="sortOrder$ | async | sortClass: column.key:'aria'"
          [class.gt-sortable]="true"
          scope="col"
        >
          <button
            *ngIf="column.value?.sortable"
            [attr.data-sort-order]="
              sortOrder$ | async | sortClass: column.key:'order'
            "
            class="gt-sort"
            (click)="
              table.isLoading ||
                !column.value.sortable ||
                sortByKey(column.key, $event)
            "
          >
            <span *ngIf="column.value?.header !== false">{{
              column.value.header || column.key | capitalCase
            }}</span>
          </button>
          <span
            *ngIf="!column.value?.sortable && column.value?.header !== false"
            >{{ column.value.header || column.key | capitalCase }}</span
          >
        </th>
      </ng-container>
      <ng-container
        *ngIf="
          ((table?.config?.rows | keyvalue: columnOrder) || [])[0] as headerRow
        "
      >
        <th
          class="row-header"
          [attr.aria-sort]="
            sortOrder$ | async | sortClass: headerRow.key:'aria'
          "
          ngClass="{{ headerRow.value.sortable ? 'sort ' : '' }} {{
            sortOrder$ | async | sortClass: headerRow.key
          }} {{ (headerRow.key | dashCase) + '-column' }}"
          (click)="
            table.isLoading ||
              !headerRow.value.sortable ||
              sortByKey(headerRow.key, $event)
          "
          scope="col"
        >
          <ng-container *ngIf="headerRow?.value?.header !== false">{{
            headerRow?.value?.header || headerRow.key | capitalCase
          }}</ng-container>
        </th>
        <th
          *ngFor="let column of ((table$ | async)?.data || [])[0]"
          ngClass="{{ headerRow.value.class }}"
        >
          <ng-container
            [ngTemplateOutlet]="
              (table.config.rows || {})[headerRow.key].templateRef
                ? templateRef
                : (table.config.rows || {})[headerRow.key].transform
                ? transformData
                : rawData
            "
            [ngTemplateOutletContext]="{
              row: column,
              column: headerRow,
              transform: (table.config.rows || {})[headerRow.key].transform,
              templateRef: (table.config.rows || {})[headerRow.key].templateRef,
              index: 0
            }"
          >
          </ng-container>
        </th>
      </ng-container>
    </tr>
  </thead>
  <tbody *ngIf="loading$ | async; else tableContent">
    <tr>
      <td class="p-0" [colSpan]="colspan$ | async">
        <ng-content select=".table-loading"></ng-content>
      </td>
    </tr>
  </tbody>
  <tfoot *ngIf="(table$ | async)! as table">
    <ng-container *ngIf="table.data.length > 0 && !(loading$ | async)">
      <ng-container *ngIf="(calculations$ | async)! as calculations">
        <tr
          *ngFor="let calculation of calculations.calculations; let i = index"
        >
          <ng-container
            *ngIf="{
              showHeader: (colspan$ | async) !== (footerColspan$ | async)
            } as footerRow"
          >
            <th
              *ngIf="footerRow.showHeader"
              [colSpan]="
                ((colspan$ | async) || 0) - ((footerColspan$ | async) || 0)
              "
              scope="row"
            >
              <ng-container
                *ngIf="table.config?.footer?.headers?.[calculation] as showHeader"
                >{{showHeader === true ? (calculation | capitalCase): table.config.footer?.headers?.[calculation]}}
              </ng-container>
            </th>
            <ng-container
              *ngFor="
                let column of table.config?.columns | keyvalue: columnOrder
              "
            >
              <td
                *ngIf="
                  !column.value?.hidden && calculations.calculated[column.key]
                "
                ngClass="{{ (column.key | dashCase) + '-column' }} {{
                  column.value.class
                }}"
                [attr.data-header]="
                  !footerRow.showHeader && table.config.footer?.headers?.[calculation]
                    ? table.config.footer?.headers?.[calculation] === true ? (calculation | capitalCase) : table.config.footer?.headers?.[calculation]
                    : null
                "
                [attr.data-label]="
                  table.config.mobileLayout && column.value.mobileHeader
                    ? column.value.mobileHeader !== true
                      ? column.value.mobileHeader
                      : (column.value.header || column.key | capitalCase)
                    : null
                "
                [class.gt-no-content]="
                  !calculations.calculated[column.key][calculation]
                "
              >
                <ng-container
                  [ngTemplateOutlet]="
                    (table.config.columns || {})[column.key].templateRef
                      ? templateRef
                      : (table.config.columns || {})[column.key].transform
                      ? transformFooter
                      : rawFooter
                  "
                  [ngTemplateOutletContext]="{
                    value: calculations.calculated[column.key][calculation],
                    row: calculations.calculated[column.key],
                    column: calculation,
                    templateRef: (table.config.columns || {})[column.key]
                      .templateRef,
                    transform: (table.config.columns || {})[column.key]
                      .transform
                  }"
                ></ng-container>
              </td>
            </ng-container>
          </ng-container>
        </tr>
      </ng-container>
    </ng-container>
  </tfoot>
</table>
<ng-template #tableContent>
  <ng-container *ngIf="(table$ | async)! as table">
    <tbody *ngIf="(table!.data![0] || table!.data!).length > 0; else noData">
      <ng-container *ngIf="table.config.columns">
        <tr
          *ngFor="
            let row of table!.data![
              table.info.lazyLoaded ? 0 : (currentPaginationIndex$ | async) || 0
            ];
            trackBy: trackRowByFn;
            let i = index
          "
          [attr.id]="'tableRow_' + i"
          (click)="table?.config?.rowClick && _rowClick(row, i, $event)"
          (mouseenter)="
            table?.config?.activateRowOnHover && _activateRow(row, i, $event)
          "
          (mouseleave)="
            table?.config?.activateRowOnHover &&
              _activateRow(null, null, $event)
          "
          [ngClass]="[
            !!isRowSelectedFn
              ? (row
                | rowSelection
                  : selection
                  : isRowSelectedFn
                  : customClasses.selectedRow)
              : '',
            (rowActive$ | async)?.index === i ? customClasses.activeRow : ''
          ]"
        >
          <ng-container
            *ngFor="let column of table.config?.columns | keyvalue: columnOrder"
          >
            <td
              *ngIf="!column.value?.hidden"
              ngClass="{{ (column.key | dashCase) + '-column' }} {{
                column.value.class
              }}"
              [attr.data-label]="
                table.config.mobileLayout && column.value.mobileHeader
                  ? column.value.mobileHeader !== true
                    ? column.value.mobileHeader
                    : (column.value.header || column.key | capitalCase)
                  : null
              "
            >
              <ng-container
                [ngTemplateOutlet]="
                  (searchBy$ | async) &&
                  !(table.config.columns || {})[column.key].templateRef
                    ? highlighted
                    : (table.config.columns || {})[column.key].templateRef
                    ? templateRef
                    : (table.config.columns || {})[column.key].transform
                    ? transformData
                    : rawData
                "
                [ngTemplateOutletContext]="{
                  row: row,
                  column: column,
                  search: (searchBy$ | async),
                  transform: (table.config.columns || {})[column.key].transform,
                  templateRef: (table.config.columns || {})[column.key]
                    .templateRef,
                  index: i,
                  data: table.data[
                    table.info.lazyLoaded
                      ? 0
                      : (currentPaginationIndex$ | async) || 0
                  ]
                }"
              ></ng-container>
            </td>
          </ng-container>
        </tr>
      </ng-container>
      <ng-container *ngIf="table.config.rows">
        <ng-container
          *ngFor="
            let row of table?.config?.rows | keyvalue: columnOrder | slice: 1;
            let i = index
          "
        >
          <tr
            *ngIf="!row.value?.hidden"
            [attr.id]="'tableRow_' + i"
            ngClass="{{ (row.key | dashCase) + '-row' }}"
            (click)="table?.config?.rowClick && _rowClick(row, i, $event)"
            (mouseenter)="
              table?.config?.activateRowOnHover && _activateRow(row, i, $event)
            "
            (mouseleave)="
              table?.config?.activateRowOnHover &&
                _activateRow(null, null, $event)
            "
            [ngClass]="[
              !!isRowSelectedFn
                ? (row
                  | rowSelection
                    : selection
                    : isRowSelectedFn
                    : customClasses.selectedRow)
                : '',
              (rowActive$ | async)?.index === i ? customClasses.activeRow : ''
            ]"
          >
            <th class="row-header" scope="row">
              {{ row.value.header || row.key | capitalCase }}
            </th>
            <td
              *ngFor="let column of (table?.data || [])[0]; let y = index"
              ngClass="{{ row.value.class }}"
            >
              <ng-container
                [ngTemplateOutlet]="
                  (table.config.rows || {})[row.key].templateRef
                    ? templateRef
                    : (table.config.rows || {})[row.key].transform
                    ? transformData
                    : rawData
                "
                [ngTemplateOutletContext]="{
                  row: column,
                  column: row,
                  transform: (table.config.rows || {})[row.key].transform,
                  templateRef: (table.config.rows || {})[row.key].templateRef,
                  index: table.config.rows ? y : i,
                  data: table.data[
                    table.info.lazyLoaded
                      ? 0
                      : (currentPaginationIndex$ | async) || 0
                  ]
                }"
              >
              </ng-container>
            </td>
          </tr>
        </ng-container>
      </ng-container>
    </tbody>
  </ng-container>
</ng-template>
<ng-template #noData>
  <tbody>
    <tr>
      <td class="p-0" [colSpan]="colspan$ | async">
        <ng-content select=".table-no-data"></ng-content>
      </td>
    </tr>
  </tbody>
</ng-template>
<ng-template
  #highlighted
  let-row="row"
  let-column="column"
  let-search="search"
  let-transform="transform"
>
  <div
    *ngIf="!transform"
    [innerHTML]="row[column.key] | highlight: search"
  ></div>
  <div
    *ngIf="transform"
    [innerHTML]="
      row[column.key]
        | dynamicPipe: transform.pipe:transform?.args
        | highlight: search
    "
  ></div>
</ng-template>
<ng-template #rawData let-row="row" let-column="column">
  {{ row[column.key] }}
</ng-template>
<ng-template
  #transformData
  let-row="row"
  let-column="column"
  let-transform="transform"
  let-data="data"
>
  {{ row[column.key] | dynamicPipe: transform.pipe:transform?.args }}
</ng-template>
<ng-template #transformFooter let-value="value" let-transform="transform">
  {{
    (value | dynamicPipe: transform.pipe:transform?.args) ||
      (tableConfig$ | async)?.footer?.emptyContent
  }}
</ng-template>
<ng-template #rawFooter let-value="value">
  {{ value || (tableConfig$ | async)?.footer?.emptyContent }}
</ng-template>
<ng-template
  #templateRef
  let-row="row"
  let-column="column"
  let-index="index"
  let-templateRef="templateRef"
  let-data="data"
>
  <ng-container
    [ngTemplateOutlet]="templateRef"
    [ngTemplateOutletContext]="{
      row: row,
      col: column,
      index: index,
      data: data
    }"
  ></ng-container>
</ng-template>
